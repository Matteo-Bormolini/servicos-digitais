<script>
    document.addEventListener('DOMContentLoaded', function () {
        const root = document.getElementById('perfil-root');
        if (!root) return;

        const usarBlur = root.dataset.usingBlur === '1';
        const autenticado = root.dataset.authenticated === '1';

        // seleciona todos campos marcados como sensíveis
        const sensiveis = Array.from(document.querySelectorAll('.sensitive-field'));

        // função que adiciona comportamento visual (aplica ou remove classe borrado)
        function aplicarEstado() {
            sensiveis.forEach(el => {
                // se não deve usar blur -> garantir sem blur
                if (!usarBlur) {
                    el.classList.remove('borrado-inline', 'hover-info');
                    const t = el.querySelector('.blur-tooltip');
                    if (t) t.remove();
                    return;
                }

                // se deve usar blur, mas usuário é autênticado -> permitir ver sem blur
                if (autenticado) {
                    el.classList.remove('borrado-inline', 'hover-info');
                    const t = el.querySelector('.blur-tooltip');
                    if (t) t.remove();
                    return;
                }

                // usar blur visual e hover-info (para mostrar tooltip)
                el.classList.add('borrado-inline', 'hover-info');

                // cria tooltip element se não existir
                if (!el.querySelector('.blur-tooltip')) {
                    const tip = document.createElement('div');
                    tip.className = 'blur-tooltip';
                    tip.textContent = el.dataset.tip || 'Informação protegida';
                    el.appendChild(tip);
                }
            });
        }

        aplicarEstado();

        // handlers: hover mostra tooltip (somente quando sensível e blur ativo)
        sensiveis.forEach(el => {
            el.addEventListener('mouseenter', function (ev) {
                if (!usarBlur || autenticado) return;
                const tip = el.querySelector('.blur-tooltip');
                if (tip) tip.classList.add('show');
            });
            el.addEventListener('mouseleave', function (ev) {
                const tip = el.querySelector('.blur-tooltip');
                if (tip) tip.classList.remove('show');
            });

            // clique: se não está autenticado (ou seja visitante), abrir modal
            el.addEventListener('click', function (ev) {
                if (!usarBlur) return;
                if (autenticado) return; // se autenticado, clique não faz nada (já mostra o valor)
                ev.preventDefault();
                // abrir modal bootstrap
                const modalEl = document.getElementById('loginPromptModal');
                if (modalEl) {
                    // dim page: adicionar classe ao main/root para blur todo o fundo
                    root.classList.add('page-dimmed');
                    const bsModal = new bootstrap.Modal(modalEl);
                    bsModal.show();

                    // remover blur ao fechar a modal
                    modalEl.addEventListener('hidden.bs.modal', function () {
                        root.classList.remove('page-dimmed');
                    }, { once: true });
                } else {
                    // fallback: redirecionar para login
                    window.location.href = "{{ url_for('autenticacao.login') }}";
                }
            });
        });

    });
</script>