{% extends 'estrutura/base.html' %}

{% block body %}
<main id="perfil-root"
      class="w-100 px-4 py-5 d-flex justify-content-center"
      data-using-blur="{{ '1' if usar_blur else '0' }}"
      data-authenticated="{{ '1' if current_user.is_authenticated else '0' }}">

    <section class="perfil-container">

        <div class="card perfil-card bg-light">
            <div class="card-body p-3 m-3">
                <div class="d-flex">

                    <!-- Foto -->
                    <div class="flex-shrink-0">
                        <img src="{{ foto_url }}" alt="Foto de perfil"
                             class="img-fluid rounded-3 perfil-foto" style="width:110px; height:110px; object-fit:cover;">
                    </div>

                    <div class="flex-grow-1 ms-3">
                        <!-- Nome sempre visível -->
                        <h5 class="mb-1">{{ usuario.nome }}{% if usuario.sobrenome %} {{ usuario.sobrenome }}{% endif %}</h5>

                        <!-- Email: sensível - usa blur -->
                        <p class="mb-2 pb-1">
                            {% if usar_blur %}
                                <strong>E-mail:</strong>
                                <span class="sensitive-field borrado-inline" data-tip="Faça login para ver o e-mail completo" role="button" tabindex="0">
                                    {{ email_display }}
                                </span>
                                <span class="sr-hidden">E-mail protegido.</span>
                            {% else %}
                                <strong>E-mail:</strong> {{ email_display }}
                            {% endif %}
                        </p>

                        <!-- Apagar ou Alterar mais para frente -->
                        <div class="d-flex justify-content-start rounded-3 p-2 mb-2 bg-body-tertiary">
                            <div>
                                <p class="small text-muted mb-1">Cursos</p>
                                <p class="mb-0">00</p>
                            </div>
                            <div class="px-5">
                                <p class="small text-muted mb-1">Posts</p>
                                <p class="mb-0">00</p>
                            </div>
                            <div>
                                <p class="small text-muted mb-1">Avaliações</p>
                                <p class="mb-0">5.0</p>
                            </div>
                        </div>

                        <div class="d-flex pt-1 gap-2">
                            <!-- Botões: editar apenas para o dono -->
                            {% if eh_dono %}
                                <a href="{{ url_for('editar_perfil') }}"
                                   class="btn btn-primary"
                                   style="width: 180px;">Editar Perfil</a>
                            {% endif %}

                            {% if not eh_dono %} <!-- ALTERAR -->
                                <button type="button" class="btn btn-outline-primary">Seguir</button>
                            {% endif %}

                            {# Se dono, mostrar botão para alternar ocultar_dados (se você implementou a rota toggle_ocultar) #}
                            {% if eh_dono %}
                                <form method="post" action="{{ url_for('toggle_ocultar', user_id=usuario.id) }}" class="ms-2 d-inline">
                                    {{ csrf_token() }}
                                    {% if usuario.ocultar_dados %}
                                        <button type="submit" class="btn btn-outline-secondary btn-sm">Desativar ocultação</button>
                                    {% else %}
                                        <button type="submit" class="btn btn-outline-secondary btn-sm">Ocultar dados sensíveis</button>
                                    {% endif %}
                                </form>
                            {% endif %}
                        </div>
                    </div>

                </div>
            </div>
        </div>

        {# --- Informações adicionais (ex.: Documento / Telefone) --- #}
        <div class="card mt-3">
            <div class="card-body">
                <div class="row gx-3">
                    <div class="col-12 col-md-6 mb-2">
                        <!-- DOCUMENTO -->
                        <strong>Documento</strong><br>
                        {% if tipo_doc and documento_display %}
                            {% if usar_blur %}
                                <span class="sensitive-field borrado-inline" data-tip="Documento protegido. Faça login para ver" role="button" tabindex="0">
                                    {{ documento_display }}
                                </span>
                                <span class="sr-hidden">Documento protegido.</span>
                            {% else %}
                                <span>{{ documento_display }}</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </div>

                    <div class="col-12 col-md-6 mb-2">
                        <!-- TELEFONE -->
                        <strong>Telefone</strong><br>
                        {% if telefone_display %}
                            {% if usar_blur %}
                                <span class="sensitive-field borrado-inline" data-tip="Telefone protegido. Faça login para ver" role="button" tabindex="0">
                                    {{ telefone_display }}
                                </span>
                                <span class="sr-hidden">Telefone protegido.</span>
                            {% else %}
                                <span>{{ telefone_display }}</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </div>
                </div>

                <hr>

                {# descrição simples, não sensível #}
                <div>
                    <strong>Sobre</strong>
                    <p class="mb-0">{{ usuario.descricao or 'Nenhuma descrição fornecida.' }}</p>
                </div>
            </div>
        </div>

        {% block form_editar_perfil %}{% endblock %}
    </section>

</main>
{% endblock %}

{% block scripts %}
<!-- Modal que pede login quando usuário clica em dado borrado -->
<div class="modal fade" id="loginPromptModal" tabindex="-1" aria-labelledby="loginPromptLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginPromptLabel">Acesso necessário</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Você precisa estar logado para ver essas informações.</p>
        <p class="small text-muted">Faça login para revelar dados sensíveis — mantemos sua privacidade.</p>
      </div>
      <div class="modal-footer">
        <a href="{{ url_for('login', next=request.path) }}" class="btn btn-primary">Fazer login</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
{% include 'estrutura/perfil_blur.html' %}
{% endblock %}

{% endblock %}